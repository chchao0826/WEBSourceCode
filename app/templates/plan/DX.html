<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>整理课排单</title>
    <link rel="stylesheet" href=" {{url_for('static',filename='bootstrap/css/bootstrap.css')}} ">
    <link rel="stylesheet" href=" {{url_for('static',filename='bootstrap/css/bootstrap-theme.css')}} ">
    <link rel="stylesheet" href=" {{url_for('static',filename='bootstrap/css/bootstrap-theme.min.css')}} ">
    <link rel="stylesheet" href=" {{url_for('static',filename='bootstrap/css/dragslot.css')}} ">
    <!-- <link rel="stylesheet" href=" {{url_for('static',filename='Scheduling/css/bootstrap_var.css')}} "> -->
    <link rel="stylesheet" href=" {{url_for('static',filename='plan/css/plan_DX.css')}} ">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap-theme.min.css"
        integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
    <style type="text/css">
        .currentli {
            color: #186ecc;
            font-size: 15px;
            font-weight: 700;
        }
    </style>
</head>

<body id="body" class="">
    <div class="left-div float-left">
        <nav class="navbar navbar-default">
            <div class="container-fluid">
                <div class="navbar-header">
                    <a class="navbar-brand" href=" {{ url_for('plan.DXIndex', sWorkingProcedureName = 'PS' ) }} ">预定</a>
                    <a class="navbar-brand" href=" {{ url_for('plan.DXIndex', sWorkingProcedureName = 'SE' ) }} ">成定</a>
                </div>
                <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                    <ul class="nav navbar-nav">
                        <li><a href="#" onclick="refresh()">刷新</a><span class="sr-only"></span></a></li>
                        <li><a href="#" onclick="printPage()">打印<span class="sr-only"></span></a></li>
                        <li><a href="#" onclick="ExportExcel()">导出<span class="sr-only"></span></a></li>
                    </ul>
                    <div class="navbar-form navbar-left">
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="卡号" id="sSearchInput">
                        </div>
                        <button type="" class="btn btn-default" name="btnup" style="margin-top: 0px;"
                            onclick="SearchInput('btnup')">搜索</button>
                    </div>
                </div>
            </div>
        </nav>
        <div style="overflow-y:scroll; ">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th style="width: 10%;">卡号</th>
                        <th style="width: 10%;">布种</th>
                        <th style="width: 10%;">颜色</th>
                        <th style="width: 10%;">幅宽</th>
                        <th style="width: 10%;">克重</th>
                        <th style="width: 10%;">投胚</th>
                        <th style="width: 10%;">预计时间</th>
                        <th style="width: 10%;">温度</th>
                        <th style="width: 10%;">速度</th>
                        <th style="width: 10%;">当前工段</th>
                    </tr>
                </thead>
            </table>
        </div>
        <div class="table-style" style="overflow-y:scroll; overflow-x:scroll; margin-top: -21px;">
            <table class="table table-bordered" id="dataTable">
                {% for i in ReturnData %}
                <tr onclick="onclicktr('{{i['uppTrackJobGUID']}}')" id="{{i['uppTrackJobGUID']}}"
                    style="background-color: {{i['sBorderColor']}}">
                    <td style="width: 10%;">{{i['sCardNo']}}</td>
                    <td style="width: 10%;">{{i['sMaterialNo']}}</td>
                    <td style="width: 10%;">{{i['sColorNo']}}</td>
                    <td style="width: 10%;">{{i['sProductWidth']}}</td>
                    <td style="width: 10%;">{{i['sProductGMWT']}}</td>
                    <td style="width: 10%;">{{i['nFactInPutQty']}}</td>
                    <td style="width: 10%;">{{i['nTime']}}</td>
                    <td style="width: 10%;">{{i['nTemp']}}</td>
                    <td style="width: 10%;">{{i['nSpeed']}}</td>
                    <td style="width: 10%;">{{i['sWorkingProcedureName']}}</td>
                    <td hidden>{{i['uppTrackJobGUID']}}</td>
                </tr>
                {% endfor %}
            </table>
        </div>
    </div>
    <div class="mid-div float-left" style="text-align: center; height:300px; margin-top: 60px;">
        <button type="button" class="btn btn-default btn-lg"><span class="glyphicon glyphicon-arrow-up"
                aria-hidden="true"></span></button>
        <button type="button" class="btn btn-default btn-lg" onclick="AJAXDown()"><span
                class="glyphicon glyphicon-arrow-down" aria-hidden="true"></span></button>
        <button type="button" class="btn btn-default btn-lg" onclick="AJAXInsertData()"><span
                class="glyphicon glyphicon-arrow-right" aria-hidden="true"></span></button>
        <button type="button" class="btn btn-default btn-lg" onclick="AJAXDeleteData()"><span
                class="glyphicon glyphicon-arrow-left" aria-hidden="true"></span></button>
        <button type="button" class="btn btn-default btn-lg"><span class="glyphicon glyphicon-eject"
                aria-hidden="true"></span></button>
        <button type="button" class="btn btn-default btn-lg"><span class="glyphicon glyphicon-refresh"
                aria-hidden="true"></span></button>

    </div>
    <div class="right-div float-left">
        <div style="height: 80px;">
            <ul class="nav nav-pills" id="eqLi">
                {% for i in ReturnEquipment %}
                <li role="presentation"><a href="#" onclick="onclickCurrentli('{{i['ID']}}')"
                        id="{{i['ID']}}">{{i['sEquipmentNo']}}</a></li>
                {% endfor %}
            </ul>
        </div>
        <div id="DataDiv">
            <div id="dragslot" class="">
                <div style="overflow-y:scroll;">
                    <ul id="SedData">
                        {% for i in ReturnDtlData %}
                        <li class="slot-item" style="border: 0px;">
                            <div class="clearfix">
                                <div class="div-card float-left">
                                    <div class="float-left" style="width: 160px; border-right: 1px solid #111; height: 100%; text-align: center; line-height: 55px; text-align: center; line-height: 60px; background-color: {{i['sBorderColor']}}">
                                        <span>{{i['sCardNo']}}</span>
                                    </div>
                                    <div class="float-left" style="width: 123px;">
                                        <div style="border-bottom: 1px solid #111; height: 30px; text-align: center; line-height: 30px;">
                                            <span>{{i['sMaterialNo']}}</span>
                                        </div>
                                        <div style="text-align: center; line-height: 30px;">
                                            <span>{{i['nTime']}}</span>
                                        </div>
                                    </div>
                                    <div hidden>{{i['uppTrackJobGUID']}}</div>
                                    <div hidden>{{i['sCardNo']}}</div>
                                    <div hidden>{{i['sMaterialNo']}}</div>
                                    <div hidden>{{i['sColorNo']}}</div>
                                    <div hidden>{{i['sProductWidth']}}</div>
                                    <div hidden>{{i['sProductGMWT']}}</div>
                                    <div hidden>{{i['nFactInPutQty']}}</div>
                                    <div hidden>{{i['nTime']}}</div>
                                    <div hidden>{{i['nTemp']}}</div>
                                    <div hidden>{{i['nSpeed']}}</div>
                                    <div hidden>{{i['sWorkingProcedureNameCurrent']}}</div>
                                </div>
                                <div class="float-left"
                                    style="width: 21px; height:60px; background-color:{{i['sColorBorder']}}; text-align: center;">
                                </div>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="http://cdn.bootcss.com/jquery/1.11.0/jquery.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="/static/plan/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="/static/plan/js/dragslot-ZL.js"></script>
    <script type="text/javascript" src="/static/bootstrap/js/xlsx.core.min.js"></script>

    <script>
        // ClassName
        var _$ = function (id) {
            return document.getElementsByClassName(id);
        }

        // ID
        var $$ = function (id) {
            return document.getElementById(id);
        }

        // Name
        var __$ = function (id) {
            return document.getElementsByName(id);
        }

        // 尺寸修改
        var getScreen = function () {
            var nWidth = document.body.clientWidth;
            var nHeight = document.documentElement.clientHeight;
            var content = $$('body');
            content.style.width = nWidth + 'px';
            content.style.height = nHeight - 50 + 'px';
        }

        // 页面初始
        window.onload = function () {
            getScreen();
            // fullScreen();
        }

        // 修改屏幕尺寸后进行div的更新
        window.onresize = function () {
            getScreen();
        }
    
    </script>

    <script>
        // 获取时间
        var GetDate = function () {
            var day2 = new Date();
            var sYear = day2.getFullYear();
            var sMonth = day2.getMonth() + 1;
            var sDate = day2.getDate();
            var sHour = day2.getHours();
            var sMin = day2.getMinutes();
            var sSec = day2.getSeconds();
            if ((sMonth.toString().length) == 1) {
                sMonth = '0' + sMonth.toString()
            }
            if ((sDate.toString().length) == 1) {
                sDate = '0' + sDate.toString()
            }
            if ((sHour.toString().length) == 1) {
                sHour = '0' + sHour.toString()
            }
            if ((sMin.toString().length) == 1) {
                sMin = '0' + sMin.toString()
            }
            if ((sDate.toString().length) == 1) {
                sSec = '0' + sSec.toString()
            }
            var dateTime = sYear + "-" + sMonth + "-" + sDate + ' ' + sHour + ':' + sMin + ':' + sSec;
            return dateTime
        }
    
    </script>

    <script>
        // 得到当前工段
        var GetThisWork = function () {
            var thisURL = document.URL;
            var thisWorking = thisURL.split('/')[5];
            if (thisWorking.indexOf('PS') != -1) {
                thisWorking = '预定';
            } else if (thisWorking.indexOf('SE') != -1) {
                thisWorking = '成定';
            }
            return thisWorking;
        }

    </script>


    <script>

        // 点击table tr 后增加选中效果
        var onclicktr = function (trVar) {
            var trValue = $$(trVar);
            var trClass = trValue.className;
            if (trClass == 'currentli') {
                trValue.className = '';
            } else {
                trValue.className = 'currentli';
            }
        }

        // 选择机台后执行AJAX 刷新右边数据
        var onclickCurrentli = function (LiVar) {
            var LiList = $$(LiVar).parentNode.parentNode.children;
            for (var i = 0; i < LiList.length; i++) {
                LiList[i].className = '';
            }
            $$(LiVar).parentNode.className = 'active'
            $('#SedData').load('AJAXDtl/' + LiVar);
        }

        // 转移的数据+原有的数据 返回
        var GetAJAXData = function () {
            var sDateTime = GetDate()
            var ThisEq = $$('eqLi').children;
            var EqVar = ''
            for (var i = 0; i < ThisEq.length; i++) {
                if (ThisEq[i].className == 'active') {
                    EqVar = ThisEq[i].children[0].id;
                }
            }
            if (EqVar == '') {
                alert('未选择机台号');
            }
            // 左侧主表的数据
            var trList = $$('dataTable').children[0].children;
            // 右侧预排过的数据
            var DtlList = $$('SedData').children;
            var returnList = []
            var nRow = 0;
            for (var i = 0; i < DtlList.length; i++) {
                var uppTrackJobGUID = DtlList[i].children[0].children[0].children[2].innerHTML;
                var sDict = {
                    'nHDRID': EqVar,
                    'uppTrackJobGUID': uppTrackJobGUID,
                    'nRowNumber': i,
                    'tTime': sDateTime,
                }
                returnList.push(sDict);
                nRow = i + 1;
            }

            // console.log(returnList);
            
            for (var i = 0; i < trList.length; i++) {
                if (trList[i].className == 'currentli') {
                    var uppTrackJobGUID = trList[i].children[10].innerHTML;
                    var sdict = {
                        'nHDRID': EqVar,
                        'uppTrackJobGUID': uppTrackJobGUID,
                        'nRowNumber': nRow + i,
                        'tTime': sDateTime,
                    }
                    returnList.push(sdict)
                }
                // console.log(trList[i].classList);
            }
            // console.log(returnList)
            return returnList
        }

        // 删除选中的数据
        var DeleteCurrentLi = function () {
            var trHTML = ''
            var trList = $$('dataTable').children[0].children;
            for (var i = 0; i < trList.length; i++) {
                var trClass = trList[i].className;
                if (trClass != 'currentli') {
                    trHTML += trList[i].outerHTML
                }
            }
            $$('dataTable').innerHTML = trHTML;
        }

        // AJAX插入数据
        var AJAXInsertData = function () {
            var InserData = GetAJAXData();
            var sEqID = InserData[0]['nHDRID'];
            console.log('--------------')
            console.log(InserData);
            console.log('--------------')
            $.ajax({
                type: 'POST',
                url: 'AJAXInsertData',
                data: JSON.stringify(InserData),
                contentType: 'application/json; charset=UTF-8',
                dataType: 'json',
                success : function (data) {
                    AJAXRightPage();
                    AJAXLeftPage();    
                },
                error : function() {
                    AJAXRightPage();
                    AJAXLeftPage();          
                },
            });

        }

        // 获得当前机台
        var thisEqFun = function () {
            var liList = $$('eqLi').children;
            var sEqList = [];
            for (var i = 0; i < liList.length; i++) {
                if (liList[i].className == 'active') {
                    var sEqID = liList[i].children[0].id;
                    var sEqName = liList[i].children[0].innerHTML;
                    var sDict = {
                        'nHDRID': sEqID,
                        'sEquipmentName': sEqName,
                    }
                    sEqList.push(sDict);
                }
            }
            if (sEqList == '') {
                alert('未选择机台');
            }
            return sEqList;
        }


        // 删除数据
        var AJAXDeleteData = function () {
            var DeleteData = $$('SedData').children;
            var DeleteList = [];
            for (var i = 0; i < DeleteData.length; i++) {
                var LiClass = DeleteData[i].className;
                if (LiClass.indexOf('currentli') != -1) {
                    var uppTrackJobGUID = DeleteData[i].children[0].children[0].children[2].innerHTML;
                    sDict = {
                        'uppTrackJobGUID': uppTrackJobGUID
                    }
                    DeleteList.push(sDict);
                }
            }
            console.log(DeleteList);
            console.log('++++++++++++++')
            $.ajax({
                type: 'POST',
                url: 'AJAXDelete',
                data: JSON.stringify(DeleteList),
                contentType: 'application/json; charset=UTF-8',
                dataType: 'json',
                success : function (data) {
                    AJAXRightPage();
                    AJAXLeftPage();    
                },
                error : function() {
                    AJAXRightPage();
                    AJAXLeftPage();         
                },
            });

        }

        // 更新右侧页面
        var AJAXRightPage = function () {
            var thisEqVar = thisEqFun()[0]['nHDRID'];
            // console.log(thisEqVar);
            // console.log('==========================')
            $('#SedData').load('AJAXRightPage/' + thisEqVar);
            // alert('123')
        }

        // 更新左侧页面
        var AJAXLeftPage = function () {
            var thisURL = document.URL;
            var thisWorking = thisURL.split('/')[5];
            console.log(thisWorking);
            $('#dataTable').load('AJAXLeftPage/' + thisWorking);
        }


    </script>

    <script>
        // 上移下移操作
        var onclickMove = function (uppTrackJobGUID) {
            var ThisClass = $$(uppTrackJobGUID).className;
            if (ThisClass.indexOf('currentli') == '-1') {
                $$(uppTrackJobGUID).className = ThisClass + ' currentli'
            } else {
                var nRow = ThisClass.indexOf('currentli');
                var ThisClass = ThisClass.slice(0, nRow);
                $$(uppTrackJobGUID).className = ThisClass;
            }
            console.log($$(uppTrackJobGUID).className)
        }
        var AJAXDown = function () {
            var Data = $$('DataDiv').children;
            for (var i = 0; i < Data.length; i++) {
                var className = Data[i].className;
                if (className.indexOf('currentli') != '-1') {
                    console.log(i)
                }
                console.log(Data[i].classList)
            }
        }
    </script>

    <script>
        jQuery(function ($) {
            $('#dragslot').dragslot({
                dropCallback: function (el) {
                    //	alert(el);
                }
            });
        });
    </script>

    <script>
        // 刷新页面
        var refresh = function () {
            location.reload()
        }
        // 打印
        var printPage = function () {

        }
    </script>

    <script>
        //获取当前时间
        var getDateTime = function(){
            var myDate = new Date()
            var myDay = myDate.getDate();
            var myMonth = myDate.getMonth();
            var myYear = myDate.getFullYear();
            if (myDay.toString().length < 2){
                myDay = 0 + myDay.toString();
            }
            if (myMonth.toString().length < 2){
                myMonth = 0 + (myMonth + 1).toString();   
            }
            var DataTime = myYear + '-' + myMonth + '-' + myDay;
            return DataTime
        }
 
    </script>
    <script>

        function sheet2blob(sheet, sheetName) {
            sheetName = sheetName || 'sheet1';
            var workbook = {
                SheetNames: [sheetName],
                Sheets: {}
            };
            workbook.Sheets[sheetName] = sheet;
            // 生成excel的配置项
            var wopts = {
                bookType: 'xlsx', // 要生成的文件类型
                bookSST: false, // 是否生成Shared String Table，官方解释是，如果开启生成速度会下降，但在低版本IOS设备上有更好的兼容性
                type: 'binary'
            };
            var wbout = XLSX.write(workbook, wopts);
            var blob = new Blob([s2ab(wbout)], {
                type: "application/octet-stream"
            });
            // 字符串转ArrayBuffer
            function s2ab(s) {
                var buf = new ArrayBuffer(s.length);
                var view = new Uint8Array(buf);
                for (var i = 0; i != s.length; ++i) view[i] = s.charCodeAt(i) & 0xFF;
                return buf;
            }
            return blob;
        }

        function openDownloadDialog(url, saveName) {
            if (typeof url == 'object' && url instanceof Blob) {
                url = URL.createObjectURL(url); // 创建blob地址
            }
            var aLink = document.createElement('a');
            aLink.href = url;
            aLink.download = saveName || ''; // HTML5新增的属性，指定保存文件名，可以不要后缀，注意，file:///模式下不会生效
            var event;
            if (window.MouseEvent) event = new MouseEvent('click');
            else {
                event = document.createEvent('MouseEvents');
                event.initMouseEvent('click', true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
            }
            aLink.dispatchEvent(event);
        }

        var ExportExcel = function () {
            var ulList = $$('SedData').children;
            var sWork = GetThisWork();
            var sthisEqFun = thisEqFun()[0]['sEquipmentName'];
            var aoa = [];
            var excelT = [sWork + sthisEqFun +'预排', null, null, null, null, null, null, null, null, null];
            aoa.push(excelT);

            var excelTitle = ['卡号', '物料编号', '色号', '幅宽', '克重', '投胚量', '预计花费时间', '温度', '速度', '工段', '类别'];
            aoa.push(excelTitle);

            for (var i = 0; i < ulList.length; i++) {
                var sCardNo = ulList[i].children[0].children[0].children[3].innerHTML
                var sMaterialNo = ulList[i].children[0].children[0].children[4].innerHTML
                var sColorNo = ulList[i].children[0].children[0].children[5].innerHTML
                var sProductWidth = ulList[i].children[0].children[0].children[6].innerHTML
                var sProductGMWT = ulList[i].children[0].children[0].children[7].innerHTML
                var nFactInPutQty = ulList[i].children[0].children[0].children[8].innerHTML
                var nTime = ulList[i].children[0].children[0].children[9].innerHTML
                var nTemp = ulList[i].children[0].children[0].children[10].innerHTML
                var nSpeed = ulList[i].children[0].children[0].children[11].innerHTML
                var sWorkingProcedureName = ulList[i].children[0].children[0].children[12].innerHTML
                var excelVar = [
                    sCardNo, sMaterialNo, sColorNo, sProductWidth, sProductGMWT, nFactInPutQty, nTime,
                    nTemp, nSpeed, sWorkingProcedureName
                ];
                aoa.push(excelVar);

            }
            console.log(aoa);
            var sheet = XLSX.utils.aoa_to_sheet(aoa);
            sheet['!merges'] = [
                // 设置A1-C1的单元格合并
                {
                    s: {
                        r: 0,
                        c: 0
                    },
                    e: {
                        r: 0,
                        c: 16
                    }
                }
            ];
            dateTime = getDateTime();
            var excelName = sWork + sthisEqFun + '排单' + dateTime + '.xlsx';
            openDownloadDialog(sheet2blob(sheet), excelName);
        }
    </script>


</body>

</html>