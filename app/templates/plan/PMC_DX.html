<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>定型预排生管排单</title>
    <link rel="stylesheet" href=" {{url_for('static',filename='bootstrap/css/bootstrap.css')}} ">
    <link rel="stylesheet" href=" {{url_for('static',filename='bootstrap/css/bootstrap.min.css')}} ">
    <link rel="stylesheet" href=" {{url_for('static',filename='plan/css/dragslot.css')}} ">
    <link rel="stylesheet" href=" {{url_for('static',filename='plan/css/plan_PMC.css')}} ">

    <style type="text/css">

        /* 选中效果 */
        .currentli {
            color: #186ecc;
            font-weight: 700;
        }

        .currentTitle {
            color: #000;
        }

        /* 搜索找到效果 */
        .findOut {
            background-color:palevioletred !important;
        }

        /* 预排效果 */
        .nowPlan {
            background-color:palegreen !important;
        }

        /* 取消预排效果 */
        .noPlan {
            background-color:yellowgreen !important;
        }

        /* ERP急件效果 */
        .ERPUrgent{
            background-color: #FFFF00 !important
        }

        /* 标记特急效果 */
        .sUrgent {
            background-color: #FFA54F !important;
        }


    </style>

</head>

<body id="body">
    <nav class="navbar navbar-default">
        <div class="container-fluid">
            <div class="navbar-header">
                <a class="navbar-brand" href=" {{ url_for('plan.PMCIndex', sWorkingProcedureName = 'PS' ) }} ">预定</a>
                <a class="navbar-brand" href=" {{ url_for('plan.PMCIndex', sWorkingProcedureName = 'SXJ1' ) }} ">水洗1</a>
                <a class="navbar-brand" href=" {{ url_for('plan.PMCIndex', sWorkingProcedureName = 'SXJ2' ) }} ">水洗2</a>
            </div>
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li><a>|</a></li>
                    <li><a href="#" onclick="GetLabel()">标记&取消特急</a></li>
                    <li><a>|</a></li>
                    <li><a href="#" onclick="ToPlan()">标记预排</a></li>
                    <li><a href="#" onclick="DeleteLabelData()">取消预排</a></li>
                    <li><a>|</a></li>
                    <li><a href="#" onclick="unCheck('up')">取消选中</a></li>
                    <li><a>|</a></li>
                    <li><a href="#" style="color:perus;" onclick="saveData()">确定</a></li>
                    <li><a>|</a></li>
                    <li><a href="#" onclick="">导入</a></li>
                    <li><a href="#" onclick="ExportExcel()">导出</a></li>
                    <li><a>|</a></li>
                    <li><a href="#" onclick="btnPrint()">打印</a></li>
                    <li><a href="#" onclick="btnRemark()">说明</a></li>
                </ul>
                <div class="navbar-form navbar-left">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="卡号 / 色号 / 布种 / ..." id="sSearchInput">
                    </div>
                    <button type="" class="btn btn-default" onclick="SearchInput()">搜索数据</button>
                </div>
                <ul class="nav navbar-nav navbar-right">
                    <li><a style="color: palevioletred;" id="showviews"></a></li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="main_var">
        <div class="outer_div">
            <div class="htmleaf-container">
                <div style="position:inherit; height: 40px; text-align: center; overflow-y:scroll;">
                    <table class="table" style="height: 40px; width:100%; z-index:2; overflow-y:scroll;">
                        <tbody>
                            <tr style="background-color:#EEE0E5;">
                                <td style="width: 4%; line-height: 25px;" class="border-left">超时</td>
                                <td style="width: 10%; line-height: 25px;" class="border-left">客户名称</td>
                                <td style="width: 5%; line-height: 25px;" class="border-left">布车号</td>
                                <td style="width: 8%; line-height: 25px;" class="border-left">物料编号</td>
                                <td style="width: 3%; line-height: 25px;" class="border-left">LOT</td>
                                <td style="width: 8%; line-height: 25px;" class="border-left">卡号</td>
                                <td style="width: 9%; line-height: 25px;" class="border-left">色号</td>
                                <td style="width: 5%; line-height: 25px;" class="border-left">投胚</td>
                                <td style="width: 5%; line-height: 25px;" class="border-left">上工段</td>
                                <td style="width: 5%; line-height: 25px;" class="border-left">现工段</td>
                                <td style="width: 5%; line-height: 25px;" class="border-left">下工段</td>
                                <td style="width: 4%; line-height: 25px;" class="border-left">生交期</td>
                                <td style="width: 4%; line-height: 25px;" class="border-left">业交期</td>
                                <td style="width: 5%; line-height: 25px;" class="border-left">耗时</td>
                                <td style="width: 8%; line-height: 25px;" class="border-left">营业课别</td>
                                <td style="width: 10%; line-height: 25px;" class="border-left">工卡备注</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <form action="" method="POST">
                    <section class="">
                        <div id="dragslot">
                            <div class="top-div" id="top-div" style="overflow-y:scroll; ">
                                <ul id="ul_var" class="" style="padding: 0; ">
                                    {% for i in PlanData %}
                                    <li class="slot-item height40 marginLeft40 {{i.sLabel}}"
                                        style="padding: 0; ">
                                        <div class="clearfix height40">
                                            <div class="hover_PMC" style="width:100%;">
                                                <table class="table">
                                                    <tr style="text-align: center;">
                                                        <td style="width: 4%; line-height: 25px;" class="border-left">{{i.nOverTime}}</td>
                                                        <td style="width: 10%; line-height: 25px;" class="border-left">{{i.sCustomerName}}</td>
                                                        <td style="width: 5%; line-height: 25px;" class="border-left">{{i.sLocation}}</td>
                                                        <td style="width: 8%; line-height: 25px;" class="border-left">{{i.sMaterialNo}}</td>
                                                        <td style="width: 3%; line-height: 25px;" class="border-left">{{i.sMaterialLot}}</td>
                                                        <td style="width: 8%; line-height: 25px;" class="border-left">{{i.sCardNo}}</td>
                                                        <td style="width: 9%; line-height: 25px;" class="border-left">{{i.sColorNo}}</td>
                                                        <td style="width: 5%; line-height: 25px;" class="border-left">{{i.nFactInputQty}}</td>
                                                        <td style="width: 5%; line-height: 25px;" class="border-left">{{i.sWorkingProcedureNameLast}}</td>
                                                        <td style="width: 5%; line-height: 25px;" class="border-left">{{i.sWorkingProcedureNameCurrent}}</td>
                                                        <td style="width: 5%; line-height: 25px;" class="border-left">{{i.sWorkingProcedureNameNext}}</td>
                                                        <td style="width: 4%; line-height: 25px;" class="border-left">{{i.dReplyDate }}</td>
                                                        <td style="width: 4%; line-height: 25px;" class="border-left">{{i.dDeliveryDate }}</td>
                                                        <td style="width: 5%; line-height: 25px;" class="border-left">{{i.nPSTime}}</td>
                                                        <td style="width: 8%; line-height: 25px;" class="border-left">{{i.sSalesGroupName}}</td>
                                                        <td style="width: 10%; line-height: 25px;" class="border-left">{{i.sRemark}}</td>
                                                        <td hidden>{{i.uppTrackJobGUID}}</td>
                                                    </tr>
                                                </table>
                                            </div>
                                        </div>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            <div style="margin-left:-40px;">
                                <ul>
                                    <li>
                                        <div class="" style="overflow-y:scroll;">
                                            <div class="hover_PMC" style="width:100%; overflow-y:scroll;">
                                                <table class="table" style="background-color:#EEE0E5;">
                                                    <tr style="text-align: center;">
                                                        <td style="width: 4%; line-height: 10px; font-size: 0.8em; font-weight: 700"
                                                            class="border-left"></td>
                                                        <td style="width: 10%; line-height: 10px; font-size: 0.8em; font-weight: 700"
                                                            class="border-left"></td>
                                                        <td style="width: 5%; line-height: 10px; font-size: 0.8em; font-weight: 700"
                                                            class="border-left"></td>
                                                        <td style="width: 8%; line-height: 10px; font-size: 0.8em; font-weight: 700"
                                                            class="border-left"></td>
                                                        <td style="width: 3%; line-height: 10px; font-size: 0.8em; font-weight: 700"
                                                            class="border-left"></td>
                                                        <td style="width: 8%; line-height: 10px; font-size: 0.8em; font-weight: 700"
                                                            class="border-left"></td>
                                                        <td style="width: 9%; line-height: 10px; font-size: 0.8em; font-weight: 700"
                                                            class="border-left"></td>
                                                        <td style="width: 5%; line-height: 10px; font-size: 0.8em; font-weight: 700"
                                                            class="border-left"></td>
                                                        <td style="width: 5%; line-height: 10px; font-size: 0.8em; font-weight: 700"
                                                            class="border-left"></td>
                                                        <td style="width: 5%; line-height: 10px; font-size: 0.8em; font-weight: 700"
                                                            class="border-left"></td>
                                                        <td style="width: 5%; line-height: 10px; font-size: 0.8em; font-weight: 700"
                                                            class="border-left"></td>
                                                        <td style="width: 4%; line-height: 10px; font-size: 0.8em; font-weight: 700"
                                                            class="border-left"></td>
                                                        <td style="width: 4%; line-height: 10px; font-size: 0.8em; font-weight: 700"
                                                            class="border-left" id="count_tr"></td>
                                                        <td style="width: 5%; line-height: 10px; font-size: 0.8em; font-weight: 700"
                                                            class="border-left" id="sum_time"></td>
                                                        <td style="width: 8%; line-height: 10px; font-size: 0.8em; font-weight: 700"
                                                            class="border-left"></td>
                                                        <td style="width: 10%; line-height: 10px; font-size: 0.8em; font-weight: 700"
                                                            class="border-left"></td>
                                                        </td>
                                                    </tr>
                                                </table>
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                            <div style="background-color:#000; height:5px; margin-top: -12px;"></div>
                            <div class="bottom-div" id="bottom-div" style="overflow-y:scroll;" style="position: fixed;">
                                <!-- <div id="section_var_PMC2" class="section_var_PMC2" style="overflow-y:scroll;"> -->
                                <ul id="bottom_ul" class="" style="margin: 0;padding: 0;">
                                    <!-- <div style="margin-top: 30px;" style="position: fixed;"> -->
                                    {% for i in NoPlanData %}
                                    <li class="slot-item height40 marginLeft40"
                                        style="padding: 0; background-color: {{i.sIsRush}}">
                                        <div class="clearfix height40">
                                            <div class="hover_PMC" style="width:100%;">
                                                <table class="table">
                                                    <tr style="text-align: center;">
                                                        <!--  -->
                                                        <td style="width: 4%; line-height: 25px;" class="border-left">{{i.nOverTime}}</td>
                                                        <td style="width: 10%; line-height: 25px;" class="border-left">{{i.sCustomerName}}</td>
                                                        <td style="width: 5%; line-height: 25px;" class="border-left">{{i.sLocation}}</td>
                                                        <td style="width: 8%; line-height: 25px;" class="border-left">{{i.sMaterialNo}}</td>
                                                        <td style="width: 3%; line-height: 25px;" class="border-left">{{i.sMaterialLot}}</td>
                                                        <td style="width: 8%; line-height: 25px;" class="border-left">{{i.sCardNo}}</td>
                                                        <td style="width: 9%; line-height: 25px;" class="border-left">{{i.sColorNo}}</td>
                                                        <td style="width: 5%; line-height: 25px;" class="border-left">{{i.nFactInputQty}}</td>
                                                        <td style="width: 5%; line-height: 25px;" class="border-left">{{i.sWorkingProcedureNameLast}}</td>
                                                        <td style="width: 5%; line-height: 25px;" class="border-left">{{i.sWorkingProcedureNameCurrent}}</td>
                                                        <td style="width: 5%; line-height: 25px;" class="border-left">{{i.sWorkingProcedureNameNext}}</td>
                                                        <td style="width: 4%; line-height: 25px;" class="border-left">{{i.dReplyDate }}</td>
                                                        <td style="width: 4%; line-height: 25px;" class="border-left">{{i.dDeliveryDate }}</td>
                                                        <td style="width: 5%; line-height: 25px;" class="border-left">{{i.nPSTime}}</td>
                                                        <td style="width: 8%; line-height: 25px;" class="border-left">{{i.sSalesGroupName}}</td>
                                                        <td style="width: 10%; line-height: 25px;" class="border-left">{{i.sRemark}}</td>
                                                        <td hidden>{{i.uppTrackJobGUID}}</td>
                                                    </tr>
                                                </table>
                                            </div>
                                        </div>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </section>
                </form>
            </div>
        </div>
    </div>

    <script src="http://cdn.bootcss.com/jquery/1.11.0/jquery.min.js" type="text/javascript"></script>

    <script>
        window.jQuery || document.write('<script src="../static/plan/js/jquery-1.11.0.min.js"><\/script>')
    </script>

    <script type="text/javascript" src="/static/plan/js/dragslot-PMC.js"></script>

    <script type="text/javascript" src="/static/bootstrap/js/xlsx.core.min.js"></script>

    <script>
        // 得到正在预排的工段
        var GetCurrentWork = function () {
            var ThisLink = document.URL;
            var Working = ThisLink.split('/')[5];
            return Working
        }
    
            // 工段返回中文
        var workToChinese = function(sWork){
            if (sWork.indexOf('PS') != -1){
                return '预定'
            }
            else if (sWork.indexOf('SXJ1') != -1){
                return '水洗1'
            }
            else if (sWork.indexOf('SXJ2') != -1){
                return '水洗2'
            }
        }
    
    </script>

    <script>
        // 获取时间
        var GetDate = function () {
            var day2 = new Date();
            var sYear = day2.getFullYear();
            var sMonth = day2.getMonth() + 1;
            var sDate = day2.getDate();
            var sHour = day2.getHours();
            var sMin = day2.getMinutes();
            var sSec = day2.getSeconds();
            if ((sMonth.toString().length) == 1) {
                sMonth = '0' + sMonth.toString()
            }
            if ((sDate.toString().length) == 1) {
                sDate = '0' + sDate.toString()
            }
            if ((sHour.toString().length) == 1) {
                sHour = '0' + sHour.toString()
            }
            if ((sMin.toString().length) == 1) {
                sMin = '0' + sMin.toString()
            }
            if ((sDate.toString().length) == 1) {
                sSec = '0' + sSec.toString()
            }
            var dateTime = sYear + "-" + sMonth + "-" + sDate + ' ' + sHour + ':' + sMin + ':' + sSec;
            return dateTime
        }
        
    </script>

    <script>
        // ClassName
        var _$ = function (id) {
            return document.getElementsByClassName(id);
        }

        // ID
        var $$ = function (id) {
            return document.getElementById(id);
        }

        // Name
        var __$ = function (id) {
            return document.getElementsByName(id);
        }

        // 尺寸修改
        var getScreen = function () {
            var nWidth = document.body.clientWidth;
            var nHeight = document.documentElement.clientHeight;
            var content = $$('body');

            $$('top-div').style.height = (nHeight / 2) - 50 + 'px';
            $$('bottom-div').style.height = (nHeight / 2) - 80 + 'px';
            $$('top-div').style.nWidth = nWidth + 'px';
            $$('dragslot').style.nWidth = nWidth + 'px';
            $$('dragslot').style.height = nHeight - 92 + 'px';

            content.style.width = nWidth + 'px';
            content.style.height = nHeight - 5 + 'px';

        }

        // 页面初始
        window.onload = function () {
            getScreen();
            getCount();
        }

        // 修改屏幕尺寸后进行div的更新
        window.onresize = function () {
            getScreen();
        }
    </script>

    <script>
        jQuery(function ($) {
            $('#dragslot').dragslot({
                dropCallback: function (el) {
                    //	alert(el);
                }
            });
        });
    </script>

    <script>
        // 取消上部分选中 // top-div      
        var unCheck = function (UpOrDown) {
            var topli = ''
            if (UpOrDown == 'up') {
                topli = $$('top-div').children[0].children;
            } else if (UpOrDown == 'down') {
                topli = $$('bottom-div').children[0].children;
            }
            for (var i = 0; i < topli.length; i++) {
                topli[i].classList.remove("currentli");
            }
        }

        // 标记特急件
        var GetLabel = function () {
            var topli = $$('top-div').children[0].children;
            for (var i = 0; i < topli.length; i++) {
                var iFlag = 0;
                var classListVar = topli[i].classList;
                for (var a = 0; a < classListVar.length; a++) {
                    if (classListVar[a] == 'currentli') {
                        var ThisClass = topli[i].className;
                        // 标记急件
                        if (ThisClass.indexOf('sUrgent') == -1) {
                            topli[i].className += ' sUrgent';
                            topli[i].classList.remove('currentli');
                            // 得到标记预排的卡号和盒车,去对应相同的盒车,现将相同的盒车找到,去除标记的卡号进行置顶,标记的卡号最后置顶,起到连带的作用
                            var sThisLocation = topli[i].children[0].children[0].children[0].children[0].children[0].children[2].innerHTML;
                            var sThisCardNo = topli[i].children[0].children[0].children[0].children[0].children[0].children[5].innerHTML;
                            for (var v = 0; v < topli.length; v ++){
                                var sLocation = topli[v].children[0].children[0].children[0].children[0].children[0].children[2].innerHTML;
                                var sCardNo = topli[v].children[0].children[0].children[0].children[0].children[0].children[5].innerHTML;
                                if(sLocation == sThisLocation && sCardNo != sThisCardNo){
                                    // var newli = topli[v];
                                    // topli[v].remove();
                                    topli[0].before(topli[v]);
                                }
                            }
                            for (var v = topli.length - 1; v >= 0; v --){
                                var sLocation = topli[v].children[0].children[0].children[0].children[0].children[0].children[2].innerHTML;
                                var sCardNo = topli[v].children[0].children[0].children[0].children[0].children[0].children[5].innerHTML;
                                if(sLocation == sThisLocation && sCardNo == sThisCardNo){
                                    // var newli = topli[v];
                                    // topli[v].remove();
                                    topli[0].before(topli[v]);
                                }
                            }

                            // // $$('top-div').children[0].insertBefore(newli);
                            // topli[i].remove()
                            // $('ul_var').insertBefore(moveLi, 0);
                        }
                        // 取消急件
                        else if (ThisClass.indexOf('sUrgent') != -1){
                            var moveLi = topli[i];
                            var sThisLocation = topli[i].children[0].children[0].children[0].children[0].children[0].children[2].innerHTML;
                            topli[i].classList.remove('sUrgent');
                            topli[i].classList.remove('currentli');
                            var nRow1 = 0;
                            var nRow2 = 0;
                            for (var v = topli.length - 1; v >= 0 ; v--){
                                var sLocation = topli[v].children[0].children[0].children[0].children[0].children[0].children[2].innerHTML;
                                console.log(sLocation)
                                console.log(sThisLocation)
                                if (topli[v].className.indexOf('sUrgent') != -1 && sLocation == sThisLocation){
                                    nRow1 = v;
                                    break;
                                }
                                else if (topli[v].className.indexOf('sUrgent') != -1 && sLocation != sThisLocation){
                                    nRow2 = v;
                                }
                            }
                            for (var v = 0; v < topli.length; v++){
                                var sLocation1 = topli[nRow1].children[0].children[0].children[0].children[0].children[0].children[2].innerHTML;
                                var sLocation2 = topli[nRow2].children[0].children[0].children[0].children[0].children[0].children[2].innerHTML;
                                var sThisLocation2 = topli[v].children[0].children[0].children[0].children[0].children[0].children[2].innerHTML;
                                if (sLocation1 == sThisLocation2){
                                    nRow1 = v ;
                                }
                                if (sLocation2 == sThisLocation2){
                                    nRow2 = v ;
                                }
                            }


                            console.log(nRow1);
                            console.log(nRow2);
                            // 同布车内有急件,且为最后一个,需要将取消的急件,放置到最后,其他不变
                            if (nRow1 > nRow2){
                                topli[nRow1 + 1].before(topli[i]);
                                // console.log(topli[nRow1])
                            }
                            else if(nRow1 < nRow2){
                                console.log('-------------')
                                for (var v = topli.length - 1; v >= 0 ; v--){
                                    var sLocation = topli[v].children[0].children[0].children[0].children[0].children[0].children[2].innerHTML;
                                    if (sLocation == sThisLocation){
                                        topli[nRow2 + 1].before(topli[v])
                                        // console.log(topli[nRow2])
                                    }
                                }
                            }
                            else if (nRow1 == nRow2 == 0){
                                topli[i].className.remove('sUrgent');
                            }

                        }
                    }
                }
            }
        }

        //  标记预排
        var ToPlan = function () {
            var bottomli = $$('bottom-div').children[0].children;
            var PlanList = [];
            for (var i = 0; i < bottomli.length; i++) {
                var liClassName = bottomli[i].className;
                console.log(liClassName);
                if (liClassName.indexOf('currentli') != -1) {
                    var getLocation = bottomli[i].children[0].children[0].children[0].children[0].children[0].children[2].innerHTML;
                    
                    for(var a = bottomli.length - 1; a >= 0; a--){
                        var thisLocation = bottomli[a].children[0].children[0].children[0].children[0].children[0].children[2].innerHTML;  
                        if (thisLocation == getLocation){
                            PlanList.push(bottomli[a]);
                            bottomli[a].remove();
                        }
                    }
                    // break;
                }
            }
            // console.log(PlanList)
            // console.log(PlanList.length)
            for(var i = PlanList.length - 1; i >= 0; i--){
                // console.log(PlanList[i]);
                PlanList[i].classList.remove("currentli");
                PlanList[i].className += ' nowPlan'
                $$('ul_var').append(PlanList[i]);
            }
            console.log(PlanList)
        }

        // 删除数据
        var DeleteLabelData = function () {
            var topli = $$('top-div').children[0].children;
            var removeLi = []
            for (var i = 0; i < topli.length; i++) {
                if (topli[i].className.indexOf('currentli') != -1) {
                    var thisLi = topli[i];
                    var thisLocation = topli[i].children[0].children[0].children[0].children[0].children[0].children[2].innerHTML;
                    for (var a = topli.length - 1; a >= 0; a--){
                        var varLocation = topli[a].children[0].children[0].children[0].children[0].children[0].children[2].innerHTML;
                        if (thisLocation == varLocation){
                            removeLi.push(topli[a]);
                            topli[a].remove()
                        }
                    }
                }
            }
            for (var i = removeLi.length - 1; i >= 0; i--){
                removeLi[i].classList.remove("currentli");
                removeLi[i].className += ' noPlan';
                $$('bottom_ul').append(removeLi[i])
            }
        }

    </script>

    <script>
        //刷新页面
        var Refresh = function () {
            location.reload();
        }

    </script>

    <script>
        // 查找数据函数
        var findInBrowser = function(findData, inputVar, sFlag){
            var iFlag = 0
            for (var i = 0; i < findData.length; i++){
                findData[i].classList.remove('findOut');
            }
            for (var i = 0; i < findData.length; i++){
                var sCardNo = findData[i].children[0].children[0].children[0].children[0].children[0].children[5].innerHTML;
                var sMaterialNo = findData[i].children[0].children[0].children[0].children[0].children[0].children[3].innerHTML;
                var sWoring = findData[i].children[0].children[0].children[0].children[0].children[0].children[9].innerHTML;
                var sSalesGroupName = findData[i].children[0].children[0].children[0].children[0].children[0].children[14].innerHTML;
                if (sCardNo.indexOf(inputVar) != -1 || sMaterialNo.indexOf(inputVar) != -1 || 
                    sWoring.indexOf(inputVar) != -1 || sSalesGroupName.indexOf(inputVar) != -1){
                    if (sFlag == 'top'){
                        $$('showviews').innerHTML = sCardNo + '已预排'
                        findData[i].className += ' findOut';
                        $$('top-div').scrollTop = (i - 5) * 40;
                        iFlag = 1
                    }
                    else if (sFlag == 'bottom'){
                        $$('showviews').innerHTML = sCardNo + '未预排'
                        findData[i].className += ' findOut';
                        $$('bottom-div').scrollTop = (i - 5) * 40;
                        iFlag = 1
                    }
                }
            }
            return iFlag
        }

        // 得到最后一个卡号
        var GetLastCardNo = function (findData){
            for(var i = findData.length; i >= 0; i--){
                var sCardNo = findData[i].children[0].children[0].children[0].children[0].children[0].children[5].innerHTML;
                return sCardNo
            }
        }

        // 搜索按钮
        var SearchInput = function () {
            var thisWorking = GetCurrentWork()

            // 搜索按钮事件
            var inputVar = $$('sSearchInput').value;
            // 上部
            var topLi = $$('ul_var').children;
            // 下部
            var bottomLi = $$('bottom_ul').children;

            // console.log(inputVar)
            // 初始化颜色

            var iflag = 0
            // 已经预排的数据
            var iflag = findInBrowser(topLi, inputVar, 'top');

            // 未预排的数据
            var iflag = findInBrowser(bottomLi, inputVar, 'bottom');
          
            // 数据里面的数据
            console.log(inputVar)
            if (iflag == 0){
                $('#bottom-div').load('Search/' + inputVar+'_'+thisWorking);
                var Exec = function(bottomLi){
                    var sCardNo = GetLastCardNo(bottomLi)
                    $$('showviews').innerHTML = sCardNo + '未预排'
                    $$('bottom-div').scrollTo(0,40 * bottomLi.length + 40);
                    
                }
                var t = setTimeout(Exec(bottomLi),50000);
            }
            // 重新计数
            getScreen();
        }
    
    </script>

    <script>
        // 点击备注按钮
        var btnRemark = function () {
            var url = "http://198.168.6.56:5000/plan/PMC/Operation";
            window.open(url, '说明', 'height=400, width=320, top=270%, left=600%')
        }

    </script>

    <script>
        // 打印
        var btnPrint = function () {
            var sWork = GetCurrentWork();
            var url = "http://198.168.6.56:5000/plan/PMC/ZL/Print/" + sWork;
            window.open(url)
        }

    </script>

    <script>

        function changeTwoDecimal(x) {
            var f_x = parseFloat(x);
            if (isNaN(f_x)) {
                alert('function:changeTwoDecimal->parameter error');
                return false;
            }
            f_x = Math.round(f_x * 100) / 100;
            return f_x;
        }
        
        // 求和以及计数
        var getCount = function () {
            var liList = $$('ul_var').children;
            var nCount = liList.length;
            var nCountVar = nCount - 1;
            var PSTimeList = __$('PSTime');
            var nSumPSTime = 0
            for (var i = 0; i < liList.length; i++) {
                nPSTime = liList[i].children[0].children[0].children[0].children[0].children[0].children[13]
                    .innerText;
                nSumPSTime += parseFloat(nPSTime);
            }
            if (isNaN(nSumPSTime)) {
                nSumPSTime = 0
            }
            $$('sum_time').innerHTML = changeTwoDecimal(nSumPSTime);
            $$('count_tr').innerHTML = nCountVar;
        }
    
    </script>


    <script>
        //获取当前时间
        var getDateTime = function () {
            var myDate = new Date()
            var myDay = myDate.getDate();
            var myMonth = myDate.getMonth();
            var myYear = myDate.getFullYear();
            if (myDay.toString().length < 2) {
                myDay = 0 + myDay.toString();
            }
            if (myMonth.toString().length < 2) {
                myMonth = 0 + (myMonth + 1).toString();
            }
            var DataTime = myYear + '-' + myMonth + '-' + myDay;
            return DataTime
        }
    
    </script>

    <script>
        // 保存按钮
        var saveData = function (){
            var sWork = GetCurrentWork();
            var sWoring = workToChinese(sWork);
            var ulLi = $$('ul_var').children;
            var GetThisDate = GetDate();
            var PostLi = []
            for (var i = 0; i < ulLi.length; i++){
                var uppTrackJobGUID = ulLi[i].children[0].children[0].children[0].children[0].children[0].children[16].innerHTML;
                console.log()
                var sLabel = 0
                if (ulLi[i].className.indexOf('sUrgent') != -1){
                    sLabel = 1
                }
                if (uppTrackJobGUID != ""){
                    sDict = {
                        'sType' : sWoring,
                        'uppTrackJobGUID' : uppTrackJobGUID,
                        'nRowNumber' : i,
                        'sLabel' : sLabel,
                        'tUpdateTime' : GetThisDate,
                    }
                    PostLi.push(sDict);
                }

                ulLi[i].classList.remove('currentli');
                ulLi[i].classList.remove('findOut');
                ulLi[i].classList.remove('nowPlan');
            }
            $.ajax({
                type: 'POST',
                url: 'PostData',
                data: JSON.stringify(PostLi),
                contentType: 'application/json; charset=UTF-8',
                dataType: 'json',
                success: function (data) {},
            });
        }
    </script>

    <script>
         
        // 导出EXCEL
        function sheet2blob(sheet, sheetName) {
            sheetName = sheetName || 'sheet1';
            var workbook = {
                SheetNames: [sheetName],
                Sheets: {}
            };
            workbook.Sheets[sheetName] = sheet;
            // 生成excel的配置项
            var wopts = {
                bookType: 'xlsx', // 要生成的文件类型
                bookSST: false, // 是否生成Shared String Table，官方解释是，如果开启生成速度会下降，但在低版本IOS设备上有更好的兼容性
                type: 'binary'
            };
            var wbout = XLSX.write(workbook, wopts);
            var blob = new Blob([s2ab(wbout)], {
                type: "application/octet-stream"
            });
            // 字符串转ArrayBuffer
            function s2ab(s) {
                var buf = new ArrayBuffer(s.length);
                var view = new Uint8Array(buf);
                for (var i = 0; i != s.length; ++i) view[i] = s.charCodeAt(i) & 0xFF;
                return buf;
            }
            return blob;
        }

        function openDownloadDialog(url, saveName) {
            if (typeof url == 'object' && url instanceof Blob) {
                url = URL.createObjectURL(url); // 创建blob地址
            }
            var aLink = document.createElement('a');
            aLink.href = url;
            aLink.download = saveName || ''; // HTML5新增的属性，指定保存文件名，可以不要后缀，注意，file:///模式下不会生效
            var event;
            if (window.MouseEvent) event = new MouseEvent('click');
            else {
                event = document.createEvent('MouseEvents');
                event.initMouseEvent('click', true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
            }
            aLink.dispatchEvent(event);
        }

        var ExportExcel = function () {
            var ulList = $$('ul_var').children;
            var sWork = GetCurrentWork();
            var sWork = workToChinese(sWork);
            var aoa = [];

            var excelT = [sWork + '预排', null, null, null, null, null, null, null, null, null, null, null, null,
                null, null, null, null
            ];
            aoa.push(excelT);

            var excelTitle = ['工段名称', '超时', '客户名称', '布车号', '物料编号', 'LOT', '卡号', '色号', '投胚', '上工段', '现工段', '下工段',
                '生交期', '业交期', '耗时', '营业课别', '工卡备注'
            ];
            aoa.push(excelTitle);

            for (var i = 0; i < ulList.length; i++) {
                var liList = ulList[i].children[0].children[0].children[0].children[0].children;
                for (var a = 0; a < liList.length; a++) {
                    var tdList = liList[a].children;
                    var nOverTime = tdList[0].innerText; //超时
                    var sCustomerName = tdList[1].innerText; //客户名称
                    var sLocation = tdList[2].innerText; //布车号	
                    var sMaterialNo = tdList[3].innerText; //物料编号
                    var sMaterialLot = tdList[4].innerText; //LOT
                    var sCardNo = tdList[5].innerText; //卡号
                    var sColorNo = tdList[6].innerText; //色号
                    var nFactInputQty = tdList[7].innerText; //投胚	
                    var sWorkingProcedureNameLast = tdList[8].innerText; //上工段	
                    var sWorkingProcedureNameCurrent = tdList[9].innerText; //现工段
                    var sWorkingProcedureNameNext = tdList[10].innerText; //下工段
                    var dReplyDate = tdList[11].innerText; //生交期
                    var dDeliveryDate = tdList[12].innerText; //业交期
                    var nPSTime = tdList[13].innerText; //耗时	
                    var sSalesGroupName = tdList[14].innerText; //营业课别
                    var sRemark = tdList[15].innerText; //工卡备注
                    var excelVar = [
                        sWork, nOverTime, sCustomerName, sLocation, sMaterialNo, sMaterialLot, sCardNo,
                        sColorNo, nFactInputQty, sWorkingProcedureNameLast, sWorkingProcedureNameCurrent,
                        sWorkingProcedureNameNext, dReplyDate, dDeliveryDate, nPSTime, sSalesGroupName, sRemark
                    ];
                    aoa.push(excelVar);
                }

            }
            console.log(aoa);
            var sheet = XLSX.utils.aoa_to_sheet(aoa);
            sheet['!merges'] = [
                // 设置A1-C1的单元格合并
                {
                    s: {
                        r: 0,
                        c: 0
                    },
                    e: {
                        r: 0,
                        c: 16
                    }
                }
            ];
            dateTime = getDateTime();
            var excelName = sWork + '排单' + dateTime + '.xlsx';
            openDownloadDialog(sheet2blob(sheet), excelName);
        }
    
    </script>

</body>

</html>