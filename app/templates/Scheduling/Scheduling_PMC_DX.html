<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>定型预排生管排单</title>
    <link rel="stylesheet" href=" {{url_for('static',filename='bootstrap/css/bootstrap.css')}} ">
    <link rel="stylesheet" href=" {{url_for('static',filename='bootstrap/css/bootstrap.min.css')}} ">
    <link rel="stylesheet" href=" {{url_for('static',filename='Scheduling/css/dragslot.css')}} ">
    <link rel="stylesheet" href=" {{url_for('static',filename='Scheduling/css/Scheduling_PMC.css')}} ">


    <style type="text/css">
        .currentli {
            color: #186ecc;
            font-weight: 700;
        }

        .currentTitle {
            color: #000;
        }
    </style>
</head>

<body id="body">
    <nav class="navbar navbar-default">
        <div class="container-fluid">
            <div class="navbar-header">
                <a class="navbar-brand"
                    href=" {{ url_for('Scheduling.PMCIndex', sWorkingProcedureName = '预定' ) }} ">预定</a>
                <a class="navbar-brand"
                    href=" {{ url_for('Scheduling.PMCIndex', sWorkingProcedureName = '水洗1' ) }} ">水洗1</a>
                <a class="navbar-brand"
                    href=" {{ url_for('Scheduling.PMCIndex', sWorkingProcedureName = '水洗2' ) }} ">水洗2</a>
            </div>
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li><a href="#" onclick="">更新数据<span class="sr-only"></span></a></li>
                    <li><a href="#" onclick="GetLabel()">标记特急</a></li>
                    <li><a href="#" onclick="LossLabel()">取消特急</a></li>
                    <li><a href="#" onclick="DeleteLabelData()">取消预排</a></li>
                    <li><a href="#" onclick="unCheck('up')">取消选中</a></li>
                    <li><a>|</a></li>
                    <li><a href="#" onclick="CheckScheduling()">标记预排</a></li>
                    <li><a href="#" onclick="unCheck('down')">取消选中</a></li>
                    <li><a>|</a></li>
                    <li><a href="#" onclick="btnPrint()">打印</a></li>
                    <li><a href="#" onclick="ExportExcel()">导出数据</a></li>
                    <li><a href="#" onclick="btnRemark()">说明</a></li>
                </ul>
                <div class="navbar-form navbar-left">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="卡号" id="sSearchInput">
                    </div>
                    <button type="" class="btn btn-default" name="btnup" onclick="SearchInput('btnup')">搜索上方数据</button>
                    <button type="" class="btn btn-default" name="btndown"
                        onclick="SearchInput('btndown')">搜索下方数据</button>
                </div>
            </div>
        </div>
    </nav>
    <div class="main_var">
        <div class="outer_div">
            <div class="htmleaf-container">
                <div style="height: 50px; text-align: center;">
                    <table class="table" style="position: fixed;">
                        <tr style="background-color:#EEE0E5;">
                            <td style="width: 4%; line-height: 25px;" class="border-left">超时</td>
                            <td style="width: 10%; line-height: 25px;" class="border-left">客户名称</td>
                            <td style="width: 5%; line-height: 25px;" class="border-left">布车号</td>
                            <td style="width: 8%; line-height: 25px;" class="border-left">物料编号</td>
                            <td style="width: 3%; line-height: 25px;" class="border-left">LOT</td>
                            <td style="width: 8%; line-height: 25px;" class="border-left">卡号</td>
                            <td style="width: 9%; line-height: 25px;" class="border-left">色号</td>
                            <td style="width: 5%; line-height: 25px;" class="border-left">投胚</td>
                            <td style="width: 5%; line-height: 25px;" class="border-left">上工段</td>
                            <td style="width: 5%; line-height: 25px;" class="border-left">现工段</td>
                            <td style="width: 5%; line-height: 25px;" class="border-left">下工段</td>
                            <td style="width: 4%; line-height: 25px;" class="border-left">生交期</td>
                            <td style="width: 4%; line-height: 25px;" class="border-left">业交期</td>
                            <td style="width: 5%; line-height: 25px;" class="border-left">耗时</td>
                            <td style="width: 8%; line-height: 25px;" class="border-left">营业课别</td>
                            <td style="width: 10%; line-height: 25px;" class="border-left">工卡备注</td>
                            <td style="width: 6%; line-height: 25px;" class="border-left"></td>
                        </tr>
                    </table>
                </div>
                <form action="" method="POST">
                    <section class="">
                        <div id="dragslot" class="">
                            <div class="top-div" id="top-div" style="overflow-y:scroll; overflow-x:scroll;">
                                <ul id="ul_var" class="" style="margin: 0;padding: 0;">
                                    {% for i in SchedulingZL_PMCDataHDR %}
                                    <li class="slot-item height40 marginLeft40"
                                        style="padding: 0; background-color: {{i.sLabel}}">
                                        <div class="clearfix height40">
                                            <div class="hover_PMC" style="width:100%;">
                                                <table class="table">
                                                    <tr style="text-align: center;">
                                                        <td style="width: 4%; line-height: 25px;" class="border-left">
                                                            {{i.nOverTime}}</td>
                                                        <td style="width: 10%; line-height: 25px;" class="border-left">
                                                            {{i.sCustomerName}}</td>
                                                        <td style="width: 5%; line-height: 25px;" class="border-left">
                                                            {{i.sLocation}}</td>
                                                        <td style="width: 8%; line-height: 25px;" class="border-left">
                                                            {{i.sMaterialNo}}</td>
                                                        <td style="width: 3%; line-height: 25px;" class="border-left">
                                                            {{i.sMaterialLot}}</td>
                                                        <td style="width: 8%; line-height: 25px;" class="border-left">
                                                            {{i.sCardNo}}</td>
                                                        <td style="width: 9%; line-height: 25px;" class="border-left">
                                                            {{i.sColorNo}}</td>
                                                        <td style="width: 5%; line-height: 25px;" class="border-left">
                                                            {{i.nFactInputQty}}</td>
                                                        <td style="width: 5%; line-height: 25px;" class="border-left">
                                                            {{i.sWorkingProcedureNameLast}}</td>
                                                        <td style="width: 5%; line-height: 25px;" class="border-left">
                                                            {{i.sWorkingProcedureNameCurrent}}</td>
                                                        <td style="width: 5%; line-height: 25px;" class="border-left">
                                                            {{i.sWorkingProcedureNameNext}}</td>
                                                        <td style="width: 5%; line-height: 25px;" class="border-left">
                                                            {{i.dReplyDate }}</td>
                                                        <td style="width: 5%; line-height: 25px;" class="border-left">
                                                            {{i.dDeliveryDate }}</td>
                                                        <td style="width: 5%; line-height: 25px;" class="border-left"
                                                            name="PSTime">
                                                            {{i.nPSTime}}</td>
                                                        <td style="width: 8%; line-height: 25px;" class="border-left">
                                                            {{i.sSalesGroupName}}</td>
                                                        <td style="width: 10%; line-height: 25px;" class="border-left">
                                                            {{i.sRemark}}</td>
                                                        <td hidden>{{i.uppTrackJobGUID}}</td>
                                                    </tr>
                                                </table>
                                            </div>
                                        </div>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            <div style="margin-left:-40px;">
                                <ul>
                                    <li>
                                        <div class="">
                                            <div class="hover_PMC" style="width:100%;">
                                                <table class="table" style="background-color:#EEE0E5;">
                                                    <tr style="text-align: center;">
                                                        <td style="width: 4%; line-height: 10px; font-size: 0.8em; font-weight: 700"
                                                            class="border-left"></td>
                                                        <td style="width: 10%; line-height: 10px; font-size: 0.8em; font-weight: 700"
                                                            class="border-left"></td>
                                                        <td style="width: 5%; line-height: 10px; font-size: 0.8em; font-weight: 700"
                                                            class="border-left"></td>
                                                        <td style="width: 8%; line-height: 10px; font-size: 0.8em; font-weight: 700"
                                                            class="border-left"></td>
                                                        <td style="width: 3%; line-height: 10px; font-size: 0.8em; font-weight: 700"
                                                            class="border-left"></td>
                                                        <td style="width: 8%; line-height: 10px; font-size: 0.8em; font-weight: 700"
                                                            class="border-left"></td>
                                                        <td style="width: 9%; line-height: 10px; font-size: 0.8em; font-weight: 700"
                                                            class="border-left"></td>
                                                        <td style="width: 5%; line-height: 10px; font-size: 0.8em; font-weight: 700"
                                                            class="border-left"></td>
                                                        <td style="width: 5%; line-height: 10px; font-size: 0.8em; font-weight: 700"
                                                            class="border-left"></td>
                                                        <td style="width: 5%; line-height: 10px; font-size: 0.8em; font-weight: 700"
                                                            class="border-left"></td>
                                                        <td style="width: 5%; line-height: 10px; font-size: 0.8em; font-weight: 700"
                                                            class="border-left"></td>
                                                        <td style="width: 5%; line-height: 10px; font-size: 0.8em; font-weight: 700"
                                                            class="border-left"></td>
                                                        <td style="width: 5%; line-height: 10px; font-size: 0.8em; font-weight: 700"
                                                            class="border-left" id="count_tr"></td>
                                                        <td style="width: 5%; line-height: 10px; font-size: 0.8em; font-weight: 700"
                                                            class="border-left" id="sum_time"></td>
                                                        <td style="width: 8%; line-height: 10px; font-size: 0.8em; font-weight: 700"
                                                            class="border-left"></td>
                                                        <td style="width: 10%; line-height: 10px; font-size: 0.8em; font-weight: 700"
                                                            class="border-left"></td>
                                                        <td style="width: 8%; line-height: 25px;" class="border-left"></td>
                                                    </tr>
                                                </table>
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                            <div style="background-color:#000; height:5px;"></div>
                            <div class="bottom-div" id="bottom-div" style="overflow-y:scroll;" style="position: fixed;">
                                <!-- <div id="section_var_PMC2" class="section_var_PMC2" style="overflow-y:scroll;"> -->
                                <ul id="" class="" style="margin: 0;padding: 0;">
                                    <!-- <div style="margin-top: 30px;" style="position: fixed;"> -->
                                    {% for i in SchedulingZL_PMCData %}
                                    <li class="slot-item height40 marginLeft40"
                                        style="padding: 0; background-color: {{i.sIsRush}}">
                                        <div class="clearfix height40">
                                            <div class="hover_PMC" style="width:100%;">
                                                <table class="table">
                                                    <tr style="text-align: center;">
                                                        <!--  -->
                                                        <td style="width: 4%; line-height: 25px;" class="border-left">
                                                            {{i.nOverTime}}
                                                        </td>
                                                        <td style="width: 10%; line-height: 25px;" class="border-left">
                                                            {{i.sCustomerName}}</td>
                                                        <td style="width: 5%; line-height: 25px;" class="border-left">
                                                            {{i.sLocation}}</td>
                                                        <td style="width: 8%; line-height: 25px;" class="border-left">
                                                            {{i.sMaterialNo}}</td>
                                                        <td style="width: 3%; line-height: 25px;" class="border-left">
                                                            {{i.sMaterialLot}}</td>
                                                        <td style="width: 8%; line-height: 25px;" class="border-left">
                                                            {{i.sCardNo}}
                                                        </td>
                                                        <td style="width: 9%; line-height: 25px;" class="border-left">
                                                            {{i.sColorNo}}</td>
                                                        <td style="width: 5%; line-height: 25px;" class="border-left">
                                                            {{i.nFactInputQty}}</td>
                                                        <td style="width: 5%; line-height: 25px;" class="border-left">
                                                            {{i.sWorkingProcedureNameLast}}</td>
                                                        <td style="width: 5%; line-height: 25px;" class="border-left">
                                                            {{i.sWorkingProcedureNameCurrent}}</td>
                                                        <td style="width: 5%; line-height: 25px;" class="border-left">
                                                            {{i.sWorkingProcedureNameNext}}</td>
                                                        <td style="width: 5%; line-height: 25px;" class="border-left">
                                                            {{i.dReplyDate }}</td>
                                                        <td style="width: 5%; line-height: 25px;" class="border-left">
                                                            {{i.dDeliveryDate }}</td>
                                                        <td style="width: 5%; line-height: 25px;" class="border-left">
                                                            {{i.nPSTime}}</td>
                                                        <td style="width: 8%; line-height: 25px;" class="border-left">
                                                            {{i.sSalesGroupName}}</td>
                                                        <td style="width: 10%; line-height: 25px;" class="border-left">
                                                            {{i.sRemark}}</td>
                                                        <td hidden>{{i.uppTrackJobGUID}}</td>
                                                    </tr>
                                                </table>
                                            </div>
                                        </div>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </section>
                </form>
            </div>
        </div>
    </div>

    <script src="http://cdn.bootcss.com/jquery/1.11.0/jquery.min.js" type="text/javascript"></script>

    <script>
        window.jQuery || document.write('<script src="../static/Scheduling/js/jquery-1.11.0.min.js"><\/script>')
    </script>

    <script type="text/javascript" src="/static/Scheduling/js/dragslot-PMC.js"></script>

    <script type="text/javascript" src="/static/bootstrap/js/xlsx.core.min.js"></script>

    <script>
        var GetCurrentWork = function () {
            var ThisLink = document.URL;
            var Working = ThisLink.split('/')[5];
            var ThisWorking = '';
            if (Working == '%E9%A2%84%E5%AE%9A' || Working == '%E9%A2%84%E5%AE%9A#') {
                ThisWorking = '预定';
                // console.log('预定');
            } else if (Working == '%E6%B0%B4%E6%B4%971' || Working == '%E6%B0%B4%E6%B4%971#') {
                ThisWorking = '水洗1';
                // console.log('水洗1');
            } else if (Working == '%E6%B0%B4%E6%B4%972' || Working == '%E6%B0%B4%E6%B4%972#') {
                ThisWorking = '水洗2';
                // console.log('水洗2');
            }
            return ThisWorking
        }
    </script>

    <script>
        // ClassName
        var _$ = function (id) {
            return document.getElementsByClassName(id);
        }

        // ID
        var $$ = function (id) {
            return document.getElementById(id);
        }

        // Name
        var __$ = function (id) {
            return document.getElementsByName(id);
        }

        // 尺寸修改
        var getScreen = function () {
            var nWidth = document.body.clientWidth;
            var nHeight = document.documentElement.clientHeight;
            var content = $$('body');

            $$('top-div').style.height = (nHeight / 2) - 100 + 'px';
            $$('bottom-div').style.height = (nHeight / 2) - 30 + 'px';
            $$('top-div').style.nWidth = nWidth + 'px';
            $$('dragslot').style.nWidth = nWidth + 'px';
            $$('dragslot').style.height = nHeight - 110 + 'px';
            content.style.width = nWidth + 'px';
            content.style.height = nHeight - 5 + 'px';

        }

        // 页面初始
        window.onload = function () {
            getScreen();
            getCount();
        }

        // 修改屏幕尺寸后进行div的更新
        window.onresize = function () {
            getScreen();
        }
    </script>

    <script>
        jQuery(function ($) {
            $('#dragslot').dragslot({
                dropCallback: function (el) {
                    //	alert(el);
                }
            });
        });
    </script>

    <script>
        // AJAX页面信息
        var AjaxPage = function () {
            ThisWork = GetCurrentWork();
            $('#dragslot').load('ZL/AJAX/UpdatePage/' + ThisWork);
            getCount();
        }

        // 取消上部分选中 // top-div      
        var unCheck = function (UpOrDown) {
            var topli = ''
            if (UpOrDown == 'up') {
                topli = $$('top-div').children[0].children;
            } else if (UpOrDown == 'down') {
                topli = $$('bottom-div').children[0].children;
            }
            for (var i = 0; i < topli.length; i++) {
                topli[i].classList.remove("currentli");
            }
        }
        // 标记特急件
        var GetLabel = function () {
            var topli = $$('top-div').children[0].children;
            for (var i = 0; i < topli.length; i++) {
                var iFlag = 0
                var classListVar = topli[i].classList;
                for (var a = 0; a < classListVar.length; a++) {
                    if (classListVar[a] == 'currentli') {
                        iFlag = 1;
                        break;
                    }
                }
                if (iFlag == 1) {
                    var ReturnList = [];
                    var CheckLabel = topli[i].children[0].children[0].children[0].children[0].children[0].children[
                        16].innerHTML;
                    // UpdateLabel_PMC(CheckLabel);
                    VarDict = {
                        'uppTrackJobGUID': CheckLabel,
                    }
                    ReturnList.push(VarDict);
                    $.ajax({
                        type: 'POST',
                        url: 'ZL/AJAX/Label/True',
                        data: JSON.stringify(ReturnList),
                        contentType: 'application/json; charset=UTF-8',
                        dataType: 'json',
                        success: function (data) {},
                    });
                    AjaxPage();
                }
            }
        }

        // 取消特急件标记
        var LossLabel = function () {
            var topli = $$('top-div').children[0].children;
            for (var i = 0; i < topli.length; i++) {
                var iFlag = 0
                var classListVar = topli[i].classList;
                for (var a = 0; a < classListVar.length; a++) {
                    if (classListVar[a] == 'currentli') {
                        iFlag = 1;
                        break;
                    }
                }
                if (iFlag == 1) {
                    var ReturnList = [];
                    var CheckLabel = topli[i].children[0].children[0].children[0].children[0].children[0].children[
                        16].innerHTML;
                    // UpdateLabel_PMC(CheckLabel);
                    VarDict = {
                        'uppTrackJobGUID': CheckLabel,
                    }

                    ReturnList.push(VarDict);

                    $.ajax({
                        type: 'POST',
                        url: 'ZL/AJAX/Label/False',
                        data: JSON.stringify(ReturnList),
                        contentType: 'application/json; charset=UTF-8',
                        dataType: 'json',
                        success: function (data) {},
                    });
                    AjaxPage();
                    getScreen();
                }
            }
        }

        // 删除数据
        var DeleteLabelData = function () {
            var topli = $$('top-div').children[0].children;
            for (var i = 0; i < topli.length; i++) {
                var iFlag = 0;
                var ReturnList = [];
                var classListVar = topli[i].classList;
                if (classListVar.length == 4){
                    var CheckLabel = topli[i].children[0].children[0].children[0].children[0].children[0].children[16].innerHTML;
                    var sLocation = topli[i].children[0].children[0].children[0].children[0].children[0].children[2].innerHTML;
                    for (var a = 0; a < topli.length; a++){
                        var sLocationVar = topli[a].children[0].children[0].children[0].children[0].children[0].children[2].innerHTML;
                        var CheckLabelVar = topli[a].children[0].children[0].children[0].children[0].children[0].children[16].innerHTML;
                        if (sLocationVar == sLocation){
                            VarDict = {
                                'uppTrackJobGUID': CheckLabelVar,
                            }
                            if(ReturnList.indexOf(VarDict) == -1){
                                ReturnList.push(VarDict);
                            }
                        }
                    }
                    $.ajax({
                        type: 'POST',
                        url: 'ZL/AJAX/delete',
                        data: JSON.stringify(ReturnList),
                        contentType: 'application/json; charset=UTF-8',
                        dataType: 'json',
                        success: function (data) {},
                    });

                }
            }
            AjaxPage();
            getCount();
            getScreen();
        }

        // 下部数据上移
        var CheckScheduling = function () {
            var bottomli = $$('bottom-div').children[0].children;
            console.log(bottomli)
            var Working = GetCurrentWork();
            var returnList = [];
            for (var i = 0; i < bottomli.length; i++) {
                // console.log(returnList);
                var liClassList = bottomli[i].classList;
                var sLocation = '';
                console.log(liClassList);
                console.log(liClassList.length);
                if (liClassList.length == 4) {
                    var uppTrackJobGUID = bottomli[i].children[0].children[0].children[0].children[0].children[0].children[16].innerHTML;
                    sLocation = bottomli[i].children[0].children[0].children[0].children[0].children[0].children[2].innerHTML;
                    var varDict = {
                        'sType': Working,
                        'uppTrackJobGUID': uppTrackJobGUID
                    }
                    console.log('----------------');
                    console.log(returnList);

                    for (var a = 0; a < bottomli.length; a++) {
                        var sLocationVar = bottomli[a].children[0].children[0].children[0].children[0].children[0].children[2].innerHTML;
                        if (sLocationVar == sLocation) {
                            var uppTrackJobGUID = bottomli[a].children[0].children[0].children[0].children[0].children[0].children[16].innerHTML;
                            var varDict = {
                                'sType': Working,
                                'uppTrackJobGUID': uppTrackJobGUID
                            }
                            if (returnList.indexOf(varDict) == -1) {
                                returnList.push(varDict);
                            }
                        console.log('------------');
                        console.log(returnList);
                        }
                    console.log('==========');
                    console.log(returnList);
                    }
                }
            }
            $.ajax({
                type: 'POST',
                url: 'ZL/AJAX/DataUpdate/' + Working,
                data: JSON.stringify(returnList),
                contentType: 'application/json; charset=UTF-8',
                dataType: 'json',
                success: function (data) {},
            });
            AjaxPage();
            getCount();
            getScreen();
        }
    </script>

    <script>
    //刷新页面
    var Refresh = function (){
        location.reload();
    }
    </script>

    <script>
        var SearchInput = function (sVar) {
            // 搜索按钮事件
            var ThisWorking = GetCurrentWork();
            var inputVar = $$('sSearchInput').value;
            var dragslot = ''
            if (sVar == 'btnup') {
                dragslot = $$('dragslot').children[0];
            } else if (sVar = 'btndown') {
                dragslot = $$('dragslot').children[3];
            }
            var LiList = dragslot.children[0].children;

            var iFlag = 0
            for (var i = 0; i < LiList.length; i++) {
                var tdList = LiList[i].children[0].children[0].children[0].children[0].children[0].children;
                // 清空选中
                var LiClassName = LiList[i].className;
                if (LiClassName.search('currentli') != -1) {
                    LiList[i].className = 'slot-item height40';
                }
                // 遍历td,寻找值
                for (var a = 0; a < tdList.length; a++) {
                    var tdValue = tdList[a].innerHTML.replace(/\s*/g, "");;
                    if (tdValue.search(inputVar) != -1) {
                        var TopHeight = document.getElementById('top-div').offsetHeight;
                        var LiHeight = LiList[i].offsetHeight;
                        var nDiff = (TopHeight / LiHeight) / 2;
                        var slow = (i - nDiff) * 40;
                        var LiClassList = LiList[i].className;
                        LiClassList += ' currentli';
                        LiList[i].className = LiClassList;
                        dragslot.scrollTop = slow;
                        iFlag = 1;
                    }
                }
            }
            returnValue = inputVar + '_' + ThisWorking;
            // 查找其他的卡号
            if (iFlag == 0 && sVar == 'btndown') {


                $('#bottom-div').load('ZL/AJAX/Search/' + returnValue);
            }
            getCount();
            getScreen();
        }
    </script>

    <script>
        var btnRemark = function () {
            var url = "http://198.168.6.56:5000/Scheduling/PMC/ZL/Remark";
            window.open(url, '说明', 'height=400, width=320, top=270%, left=600%')

        }
    </script>

    <script>
        // 打印
        var btnPrint = function () {
            var sWork = GetCurrentWork();
            var url = "http://198.168.6.56:5000/Scheduling/PMC/ZL/Print/" + sWork;
            window.open(url)
        }
    </script>

    <script>
        function changeTwoDecimal(x) {
            var f_x = parseFloat(x);
            if (isNaN(f_x)) {
                alert('function:changeTwoDecimal->parameter error');
                return false;
            }
            f_x = Math.round(f_x * 100) / 100;
            return f_x;
        }
        // 求和以及计数
        var getCount = function () {
            var liList = $$('ul_var').children;
            var nCount = liList.length;
            var nCountVar = nCount - 1;
            var PSTimeList = __$('PSTime');
            var nSumPSTime = 0
            for (var i = 0; i < liList.length; i++) {
                nPSTime = liList[i].children[0].children[0].children[0].children[0].children[0].children[13].innerText;
                nSumPSTime += parseFloat(nPSTime);
            }
            if (isNaN(nSumPSTime)) {
                nSumPSTime = 0
            }
            $$('sum_time').innerHTML = changeTwoDecimal(nSumPSTime);
            $$('count_tr').innerHTML = nCountVar;
        }
    </script>

    <script>
        //获取当前时间
        var getDateTime = function(){
            var myDate = new Date()
            var myDay = myDate.getDate();
            var myMonth = myDate.getMonth();
            var myYear = myDate.getFullYear();
            if (myDay.toString().length < 2){
                myDay = 0 + myDay.toString();
            }
            if (myMonth.toString().length < 2){
                myMonth = 0 + (myMonth + 1).toString();   
            }
            var DataTime = myYear + '-' + myMonth + '-' + myDay;
            return DataTime
        }
 
    </script>

    <script>
        var Update = function () {
            console.log('Update')
            $.ajax({
                type: 'POST',
                url: 'ZL/Updata/',
                // data: JSON.stringify(returnList),
                contentType: 'application/json; charset=UTF-8',
                dataType: 'json',
                success: function (data) {},
            });
            // $('').load('/ZL/Updata');

        }

        function sheet2blob(sheet, sheetName) {
            sheetName = sheetName || 'sheet1';
            var workbook = {
                SheetNames: [sheetName],
                Sheets: {}
            };
            workbook.Sheets[sheetName] = sheet;
            // 生成excel的配置项
            var wopts = {
                bookType: 'xlsx', // 要生成的文件类型
                bookSST: false, // 是否生成Shared String Table，官方解释是，如果开启生成速度会下降，但在低版本IOS设备上有更好的兼容性
                type: 'binary'
            };
            var wbout = XLSX.write(workbook, wopts);
            var blob = new Blob([s2ab(wbout)], {type:"application/octet-stream"});
            // 字符串转ArrayBuffer
            function s2ab(s) {
                var buf = new ArrayBuffer(s.length);
                var view = new Uint8Array(buf);
                for (var i=0; i!=s.length; ++i) view[i] = s.charCodeAt(i) & 0xFF;
                return buf;
            }
            return blob;
        }

        function openDownloadDialog(url, saveName){
            if(typeof url == 'object' && url instanceof Blob)
            {
                url = URL.createObjectURL(url); // 创建blob地址
            }
            var aLink = document.createElement('a');
            aLink.href = url;
            aLink.download = saveName || ''; // HTML5新增的属性，指定保存文件名，可以不要后缀，注意，file:///模式下不会生效
            var event;
            if(window.MouseEvent) event = new MouseEvent('click');
            else
            {
                event = document.createEvent('MouseEvents');
                event.initMouseEvent('click', true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
            }
            aLink.dispatchEvent(event);
        }

        var ExportExcel = function () {
            var ulList = $$('ul_var').children;
            var sWork = GetCurrentWork();
            var aoa  = [];

            var excelT = [sWork + '预排',null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null];
            aoa.push(excelT);

            var excelTitle = ['工段名称','超时','客户名称','布车号','物料编号','LOT','卡号','色号','投胚','上工段','现工段','下工段','生交期','业交期','耗时','营业课别','工卡备注'];
            aoa.push(excelTitle);
            
            for (var i = 0; i < ulList.length; i++){
                var liList = ulList[i].children[0].children[0].children[0].children[0].children;
                for (var a = 0; a < liList.length; a++){
                    var tdList = liList[a].children;
                    var nOverTime = tdList[0].innerText; //超时
                    var sCustomerName = tdList[1].innerText; //客户名称
                    var sLocation = tdList[2].innerText; //布车号	
                    var sMaterialNo = tdList[3].innerText; //物料编号
                    var sMaterialLot = tdList[4].innerText; //LOT
                    var sCardNo = tdList[5].innerText; //卡号
                    var sColorNo = tdList[6].innerText; //色号
                    var nFactInputQty = tdList[7].innerText; //投胚	
                    var sWorkingProcedureNameLast = tdList[8].innerText; //上工段	
                    var sWorkingProcedureNameCurrent = tdList[9].innerText; //现工段
                    var sWorkingProcedureNameNext = tdList[10].innerText; //下工段
                    var dReplyDate = tdList[11].innerText; //生交期
                    var dDeliveryDate = tdList[12].innerText; //业交期
                    var nPSTime = tdList[13].innerText; //耗时	
                    var sSalesGroupName = tdList[14].innerText; //营业课别
                    var sRemark = tdList[15].innerText; //工卡备注
                    var excelVar = [
                    sWork,nOverTime,sCustomerName,sLocation,sMaterialNo,sMaterialLot,sCardNo,sColorNo,nFactInputQty,sWorkingProcedureNameLast,sWorkingProcedureNameCurrent,sWorkingProcedureNameNext,dReplyDate,dDeliveryDate,nPSTime,sSalesGroupName,sRemark];
                    aoa .push(excelVar);
                }

            }
            console.log(aoa );
            var sheet = XLSX.utils.aoa_to_sheet(aoa);
            sheet['!merges'] = [
                // 设置A1-C1的单元格合并
                {s: {r: 0, c: 0}, e: {r: 0, c: 16}}
            ];
            dateTime = getDateTime();
            var excelName = sWork + '排单' + dateTime + '.xlsx';
            openDownloadDialog(sheet2blob(sheet), excelName);
        }
    </script>

</body>

</html>